title_wrong_type:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.title]
    schema.type = "number"
  rst: ""

title_nullable:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.title]
    schema.type = "string"
    nullable = true
  rst: ""

status_wrong_type:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.status]
    schema.type = "integer"
  rst: ""

tags_wrong_items_type:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.tags]
    schema.type = "array"
    schema.items.type = "boolean"
  rst: ""

extra_link_array_wrong_type:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [[needs.extra_links]]
    option = "links"
    outgoing = "links"
    incoming = "linked by"
    schema.type = "object"
  rst: ""

extra_link_array_wrong_item_type:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [[needs.extra_links]]
    option = "links"
    outgoing = "links"
    incoming = "linked by"
    schema.type = "array"
    schema.items = { type = "other" }
  rst: ""

extra_option_empty_schema:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.efforts]
    schema = {}
  rst: |
    .. impl:: title
        :id: IMPL_1

missing_type_select:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - select:
          properties:
            efforts: {minimum: 15}
        validate:
          local:
            required: [efforts]

missing_type_validate_local:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - validate:
          local:
            properties:
              efforts: {minimum: 15}

type_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.efforts]
    schema.type = "unknown"
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12

select_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - select:
          properties:
            efforts: {type: "unknown"}

both_definitions_and_json_given:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions = {
      "schemas": [
          {
              "select": {
                  "properties": {
                      "efforts": {"minimum": 15}
                  }
              },
              "validate": {
                  "local": {
                      "required": ["efforts"]
                  }
              }
          }
      ]
    }
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - select:
          properties:
            efforts: {minimum: 15}
        validate:
          local:
            required: [efforts]

local_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - validate:
          local:
            properties:
              efforts: {type: "unknown"}

network_link_not_exist:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          network:
            links2:
              minContains: 2

type_mismatch_object_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - validate:
          local:
            type: "array"
            items: []
            properties:
              efforts: {}

type_mismatch_object_extra_option_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - validate:
          local:
            properties:
              efforts: {type: "integer"}

type_mismatch_array_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
    needs_schema_definitions_from_json = "schemas.json"
  ubproject: |
    [needs.fields.efforts]
  rst: |
    .. impl:: title
        :id: IMPL_1
        :efforts: 12
  schemas:
    schemas:
      - validate:
          local:
            type: "object"
            items: {}

ref_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    $defs:
      type-impl:
        properties:
          type:
            const: impl
    schemas:
      - validate:
          local:
            $ref: "#/$defs/not-exist"

ref_mixed_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    $defs:
      type-impl:
        properties:
          type:
            const: impl
    schemas:
      - validate:
          local:
            $ref: "#/$defs/not-exist"
            required: [type]

ref_recursive_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    $defs:
      type-impl:
        properties:
          type:
            const: impl
        allOf:
          - $ref: "#/$defs/type-impl2"
      type-impl2:
        $ref: "#/$defs/type-impl"

    schemas:
      - validate:
          local:
            $ref: "#/$defs/type-impl"

extra_option_unknown_keys:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.efforts]
    schema.type = "string"
    schema.unknown = "unknown"
  rst: ""

extra_link_unknown_keys:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [[needs.extra_links]]
    option = "links"
    outgoing = "links"
    incoming = "linked by"
    schema.unknown = "unknown"
  rst: ""

extra_option_pattern_unsafe_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [needs.fields.efforts]
    schema.type = "string"
    schema.pattern = "^IMPL_(?!SAFE)"
  rst: ""

extra_link_pattern_unsafe_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    [[needs.extra_links]]
    option = "links"
    outgoing = "links"
    incoming = "linked by"
    schema.items = { pattern = "^IMPL_(?!SAFE)" }
  rst: ""

schemas_select_pattern_unsafe_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - select:
          properties:
            id: {pattern: "^IMPL_(?!SAFE)"}
        validate:
          local:
            required: [id]

schemas_validate_pattern_unsafe_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^IMPL_(?!SAFE)"

schemas_validate_pattern_backref_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^IMPL_(SAFE)_\\1"

schemas_validate_pattern_atomic_groups_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^(?>test)$"

schemas_validate_pattern_unnamed_groups_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^(test)?(?(1)yes|no)$"

schemas_validate_pattern_comment_groups_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^test(?#comment)$"

schemas_validate_pattern_conditional_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^(?(1)yes|no)$"

schemas_validate_pattern_subroutine_calls_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^test(?&name)$"

schemas_validate_pattern_relative_subroutine_error:
  conf: |
    extensions = ["sphinx_needs"]
    needs_schema_definitions_from_json = "schemas.json"
  rst: |
    .. impl:: title
        :id: IMPL_1
  schemas:
    schemas:
      - validate:
          local:
            properties:
              id:
                pattern: "^test(?+1)$"

network_mixed_links_and_direct_rejected:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    needs.schema_definitions_from_json = "schemas.json"

    [[needs.extra_links]]
    option = "derived_from"
  schemas:
    $defs:
      type-spec:
        properties:
          type:
            const: spec
      type-impl:
        properties:
          type:
            const: impl
    schemas:
      - id: "mixed-format-schema"
        message: Schema that mixes network.links and direct network.<type> - MUST be rejected
        select:
          $ref: '#/$defs/type-impl'
        validate:
          network:
            links:
              derived_from:
                contains:
                  local:
                    $ref: '#/$defs/type-spec'
                minContains: 99
            derived_from:
              contains:
                local:
                  $ref: '#/$defs/type-spec'
              minContains: 1
  rst: |
    .. spec:: target specification
        :id: SPEC_1

    .. impl:: implementation with one derived_from link
        :id: IMPL_1
        :derived_from: SPEC_1

network_direct_and_links_field_merge_rejected:
  conf: |
    extensions = ["sphinx_needs"]
    needs_from_toml = "ubproject.toml"
  ubproject: |
    needs.schema_definitions_from_json = "schemas.json"

    [[needs.extra_links]]
    option = "derived_from"

    [[needs.extra_links]]
    option = "tests"
  schemas:
    $defs:
      type-spec:
        properties:
          type:
            const: spec
      type-test:
        properties:
          type:
            const: test
      type-impl:
        properties:
          type:
            const: impl
    schemas:
      - id: "impl-links-schema"
        message: impl must derive from spec and be tested
        select:
          $ref: '#/$defs/type-impl'
        validate:
          network:
            links:
              tests:
                contains:
                  local:
                    $ref: '#/$defs/type-test'
                minContains: 1
            derived_from:
              contains:
                local:
                  $ref: '#/$defs/type-spec'
              minContains: 1
  rst: |
    .. spec:: specification
        :id: SPEC_1

    .. test:: test case
        :id: TEST_1

    .. impl:: implementation
        :id: IMPL_1
        :derived_from: SPEC_1
        :tests: TEST_1
